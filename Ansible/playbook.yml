---
- name: Suppression et R√©installation de Kubernetes et Docker
  hosts: all
  become: yes
  tasks:

    # ================================
    # üî¥ SUPPRESSION DE DOCKER & KUBERNETES
    # ================================

    - name: Arr√™ter et d√©sactiver Docker et Kubelet
      service:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - docker
        - kubelet
      ignore_errors: yes

    - name: D√©sinstaller Docker et Kubernetes
      apt:
        name:
          - docker.io
          - kubelet
          - kubeadm
          - kubectl
        state: absent

    - name: Supprimer les fichiers et configurations Docker & Kubernetes
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/docker
        - /var/lib/kubelet
        - /etc/docker
        - /etc/kubernetes
        - /etc/apt/sources.list.d/kubernetes.list
        - /etc/apt/sources.list.d/docker.list
      ignore_errors: yes

    - name: Nettoyer les paquets inutiles
      shell: apt autoremove -y && apt autoclean -y

    # ================================
    # üîπ INSTALLATION DE DOCKER
    # ================================

    - name: Mettre √† jour APT et installer les d√©pendances
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Ajouter la cl√© GPG de Docker
      shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /etc/apt/trusted.gpg.d/docker.asc

    - name: Ajouter le d√©p√¥t Docker
      shell: add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

    - name: Installer Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Activer et d√©marrer Docker
      service:
        name: docker
        state: started
        enabled: yes

    # ================================
    # üîπ INSTALLATION DE KUBERNETES
    # ================================

    - name: Ajouter la cl√© GPG de Kubernetes
      shell: curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo tee /etc/apt/trusted.gpg.d/kubernetes.asc

    - name: Ajouter le d√©p√¥t Kubernetes
      shell: echo "deb https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

    - name: Mettre √† jour APT et installer Kubernetes
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Activer et d√©marrer Kubelet
      service:
        name: kubelet
        state: started
        enabled: yes

    # ================================
    # üîπ V√âRIFICATION DES INSTALLATIONS
    # ================================

    - name: V√©rifier que Docker est install√©
      command: which docker
      register: docker_installed
      failed_when: docker_installed.rc != 0
      changed_when: false

    - name: V√©rifier que kubelet est install√©
      command: which kubelet
      register: kubelet_installed
      failed_when: kubelet_installed.rc != 0
      changed_when: false

    - name: V√©rifier que kubeadm est install√©
      command: which kubeadm
      register: kubeadm_installed
      failed_when: kubeadm_installed.rc != 0
      changed_when: false

    - name: V√©rifier que kubectl est install√©
      command: which kubectl
      register: kubectl_installed
      failed_when: kubectl_installed.rc != 0
      changed_when: false

    - name: V√©rifier l'√©tat du cluster Kubernetes
      command: kubectl get nodes
      register: cluster_status
      failed_when: false
      changed_when: false
      when: kubectl_installed.rc == 0

    - name: Afficher l'√©tat du cluster
      debug:
        msg: "{{ cluster_status.stdout_lines }}"
      when: kubectl_installed.rc == 0